<div id="messages"></div>
<form action="">
    <input id="msg" autocomplete="off" /><button>Send</button>
</form>
<script src="/socket.io/socket.io.js"></script> <!-- Chemin correct pour charger Socket.io -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    $(function () {
        var socket = io({ query: { username: "<%= user.username %>" } });
        const roomId = "<%= conversation._id %>"; // ID unique de la conversation

        // Charger les messages existants
        $.get(`/api/messages/${roomId}`, function (messages) {
            messages.forEach(({ sender, message }) => {
                $("#messages").append($("<p>").html(`<strong>${sender}:</strong> ${message}`));
            });
        });

        // Rejoindre la room spécifique
        socket.emit("joinRoom", roomId);
        console.log(`Rejoint la room : ${roomId}`);

        $("form").submit(function (e) {
            e.preventDefault();
            const message = $("#msg").val();
            console.log(`Tentative d'envoi du message : roomId=${roomId}, message=${message}`);
            socket.emit("chatMessage", { roomId, message });
            $("#msg").val("");
            return false;
        });

        socket.on("chatMessage", function ({ sender, message }) {
            console.log(`Message reçu : sender=${sender}, message=${message}`);
            $("#messages").append($("<p>").html(`<strong>${sender}:</strong> ${message}`));
        });
    });
</script>